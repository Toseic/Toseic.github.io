---
layout: post
title: "GB-Mahjong 国标麻将"
author: "Toseic"
tags: AI game
comments: true
excerpt_separator: <!--more-->
---

[Github仓库](https://github.com/Toseic/GB-Mahjong) *暂未开放*
## 国标麻将概述<!--more-->

### 游戏概述

国标麻将，是麻将的一种玩法，其规则为中国国家体育总局中国国家体育总局于1998年7月所制定。其后在众多国际及国内麻将竞赛中应用，故被称为国标麻将。国标麻将摒弃了大众麻将的赌博性质，同时又将番种增加至81种，极大的增加了趣味性与竞技性。国标麻将8番起和，增加了比赛的难度，同时也增加了趣味性。国标正在逐渐被大众所接受，成为一种时尚的娱乐方式。

### 实验概述

我们的AI取名为断妖酒（为断幺九之意，但是它似乎并不喜欢做断幺九23333），它主要基于人工搜索辅助监督学习的方式实现，模型包含二维卷积层，全连接层，BN(Batch Normalization)层等等，包含6.4M个参数。

人工搜索辅助：在将数据交给神经网络进行处理之前，先通过人工的经验搜索，得出较为可行的和牌目标，并将结果一起放入数据中，一起交给模型处理。

## 监督学习

### 数据结构表示

我们使用4*9的基础结构储存包括手牌，出牌，风圈等数据。

#### 手牌
<img width="663" alt="tiles" src="https://user-images.githubusercontent.com/97432569/168612929-1931cd4f-b9ea-4e44-a7a6-207a3e53d7e4.png">

我们借鉴了Suphx的表示方法，使用了四个通道表示手牌状态，但是我们在此基础上进行了一些改变，把原本的1* 34的结构更换成了4*9的格式，原本的一维卷积改成了二维卷积，这样的变化可以增强神经网络的表现能力，实验也证实了这一点，（具体数据可以在后面看到）。

<img src="https://user-images.githubusercontent.com/97432569/168612997-473da88a-6833-4e6f-8290-31e149397564.png" alt="tiles2" style="zoom: 67%;" />

#### 通道输入

一共237个通道，输入内容包括了

| 内容             | 通道数 |
| ---------------- | ------ |
| 门风             | 4      |
| 圈风             | 4      |
| 自己的手牌       | 4      |
| 自己能打出的牌   | 4      |
| 场上亮出的牌     | 16     |
| 四人出牌历史     | 37*4   |
| 有可能等到的牌   | 4      |
| 搜索出的和牌建议 | 53     |



### 模型结构

整个项目出牌模型和吃碰杠模型所构成

两个模型的构造非常接近，区别在于出牌模型的输出是1x34的，而吃碰杠模型的输出是1x90的，90对应于PASS以及所有吃碰杠的行为。

以下为模型的示意图：（激活层和BN层没有被标出来）

<img width="677" alt="model2" src="https://user-images.githubusercontent.com/97432569/168613406-0c720a40-0abe-43e7-aafb-a3ab6ee8dafa.png">

![model_info](https://user-images.githubusercontent.com/97432569/169028610-58a36158-3d7a-4b92-b07a-924afaf622d7.svg)
![call_model](https://user-images.githubusercontent.com/97432569/169028845-0328ff9f-9c5a-4efc-bd5c-0be1efc8bec2.svg)

网络由卷积层，BN层，Resblock，全连接层，以及激活层构成，其中包含18层resblock，网络在训练时并没有表现出太大的过拟合现象，训练的过程较为稳定。

残差网络能提升深层网络的稳定性，而BN层能通过数据处理减少由于浅层网络的轻微震荡而对深层网络的震荡的放大的效果，我们的网络里面并没有池化，因为池化会使得一些通道的信息被丢失。

### 人工搜索辅助

AI在训练时如果只是学会了在当前形势下的单次决策，但是对自己的目标没有确切的认识可能会导致在出牌时没有明确的方向，导致水平受到影响，在设计数据结构之前我们参考了Suphx的搜索的思路，在Suphx中研究人员通过深度优先搜索的方式给模型搜索出一百余种个可能的前瞻性和牌建议，然后将它们放入通道中供神经网络学习。

所以在训练时我们也借鉴了这种方法，通过人工搜索给它提供了和牌目标的建议，但是搜索方式并不是通过深度优先搜索去前向预测它在未来会抓到各种牌和打出各种牌之后情况，而是对现在已有的手牌，另外用场上已经被打出的牌和别人亮出的牌分析未来抓到各个牌的可能性辅助，分析出接近的和牌型。

首先我们对数据集进行和牌番型的统计，统计出各个番种占比如下：

<img src="https://user-images.githubusercontent.com/97432569/168613658-ec401f1e-8582-4ed6-bd54-e27306ae7ede.svg" alt="botzone" style="zoom: 20%;" />



我们在人工搜索是只要对较为常见的番型进行搜索即可，搜索的具体过程是对想要搜的番种设置一个所需的牌的最低值，也就是说如果手牌符合这些条件即可认为这个番型是可以尝试的。

| 番种       | 搜索策略                                                     |
| :--------- | ------------------------------------------------------------ |
| 三色三步高 | 最低要求两个搭子，一个单张，而且单张对应所需的两张牌都可以摸到 |
| 一色三步高 | 最低要求两个搭子，一个单张，包括合理性检查                   |
| 三色三同顺 | 最低要求两个搭子，一个单张，包括合理性检查                   |
| 五门齐     | 风牌和箭牌：至少一种有一个对子，另一种有一个单张。三种花色，至少两种花色有搭子或者对子，没有缺门。 |
| 花龙       | 最低要求两个搭子，一个单张，包括合理性检查                   |
| 清龙       | 至少有不重复的6张同花色牌，包括合理性检查                    |
| 清一色     | 同一花色的牌的数目超过八张，包括合理性检查                   |
| 混一色     | 同一花色的牌的数目超过(10-3x)张，其中x为风牌和箭牌的搭子和对子的数目 |
| 七对       | 已经有了四个及以上个对子即认为可以继续搜索，随后检查：是否有超过(14-x)/2张牌的剩下的数目超过2张（x为对子的数目） |
| 碰碰胡     | 至少有一个刻子或者杠子，剩下不少于（4-x）个对子（x为刻子或者杠子的数目） |
| 全不靠     | 手牌中有10张及以上符合要求，即认为可行，包括合理性检查       |
| 组合龙     | 已经有了九张中的七张及以上，而且能通过合理性检查             |
| 全带幺     | 有四个含有幺九牌的搭子或者对子，包括合理性检查               |
| 大于五     | 有十张手牌大于五并且能通过合理性检查                         |
| 小于五     | 有十张手牌小于五并且能通过合理性检查                         |
|            |                                                              |

那么如果在一局刚开始时手牌如果没办法立刻搜索出能和牌的方向怎么办呢，我们为他提供了base advice，也就是提供一个较为稳妥的出牌方式，在把一些明显并没有很大用处的牌打出之后等待自己的牌在摸牌之后能被搜索出有和牌的条件。

我们的输入的建议并不是给出确切的和牌的14张牌的结果让它自己去试着达到，而是以一种展示特征的方式提供建议，在搜索到有希望的番种后，将这种番种对应的所需要的那一部分（比如三色三步高就是那就对应的三个顺子）写入建议，那么14张牌中并不是这个番种所要求的剩下几张牌怎么告诉它呢？我们使用了一种提取特征建议的方式来告诉他，具体格式：

> 每个建议的格式为2x4x9，第一通道代表和牌的内容(番型对应的那一部分)，第二通道代表对于34种牌的留存建议，1代表非常建议留下来，0代表留存并不重要，-1代表很不建议。

比如说如果我们发现手牌比较适合做三色三步高，就可以把对应九张牌的位置的牌设成1，其他可以留牌的位置设成0，如果想要做出清一色或者混一色，就可以将这一种花色的位置设成1，其他花色设成-1，字牌则设成0（混一色），-1（清一色）。

这么做的优点在于如果我们将目标和牌方向完整的14张一一列举出来可能导致数据过多，另外由于信息不完全，我们并不能清楚的预见我们摸到的牌的可能，所以我们设计了这样的格式，希望能够以“启发”的方式给AI提供建议。

#### 搜索的效果

##### 搜索是否影响AI的行为呢？

在这个项目中我们的搜索策略经过了多次的调整，调整的内容包括了要搜索的番种，以及对于番种搜索条件的强度进行微调，我们对不同的搜索条件所训练出来的bot的打牌风格进行了一些分析，发现bot的打牌风格会很大的被搜索条件影响，比如说我们如果同时搜索了全不靠，七星不靠，组合龙，可能会导致给出的建议有重复部分，在这种搜索条件下bot在判断是否去做全不靠类型的番种时会变得很激进，这就是一个很显著的例子



## 训练曲线
![drop_loss](https://user-images.githubusercontent.com/97432569/169091273-563ced94-e83d-47bc-a17d-9f9feca5e1d4.svg)
![drop_acc](https://user-images.githubusercontent.com/97432569/169091283-0227d436-0d1b-46c3-ab83-af78c1f5ab41.svg)
![call_acc](https://user-images.githubusercontent.com/97432569/169088265-9f941df7-2bae-4920-a7bf-9a57541f1a0c.svg)
![call_loss](https://user-images.githubusercontent.com/97432569/169088284-95ae75bf-1c60-42b5-afdd-72b8334c21c8.svg)





## bot的缺陷

我们的bot的缺陷：比较明显的一点是在部分做番种的情况下牌效较为低下。

主要是在门清的情况下，而且没有找到较大一些的能做的番种（比如三色之类），这个情况下本来可以尝试不求人+一些小番数到8番，但是在这种情况下bot的行为会变得有些低效，个人分析这主要是因为在搜索时我们在这种情况下没有给出基于不求人+最大牌效的建议。

## 一些尝试

### 数据增强

由于在4x9的结构中，一到四行的排列顺序为万，条，饼，风牌和箭牌，万条饼本身在麻将规则中几乎是完全等价的，但是由于第四列的存在，是否会导致第四列的内容使得第1,2,3行在二维卷积运算时由于所处于的环境不同而导致结果受到干扰呢？这会不会使得AI在处理万,条,饼的牌时，对待他们的态度有差异呢？

我们尝试了进行数据增强的处理，即对于每组数据将万条饼交换顺序，然后把数据混在一起使用。

## 总结

### 致谢

特别致谢Pbx学长，他为我们提供了很多的有价值的建议，另外为人工搜索设计了很棒的测试数据，这个项目的完成离不开他的帮助。